/**
 * Tests for tarkov-api module
 */

import { afterEach, describe, expect, it, vi } from 'vitest';
import { fetchTasks, findTaskById, type TaskData } from '../src/lib/index.js';

describe('tarkov-api', () => {
  afterEach(() => {
    vi.unstubAllGlobals();
    vi.restoreAllMocks();
  });

  it('fetchTasks returns tasks when API request succeeds', async () => {
    const tasks: TaskData[] = [{ id: 'task-1', name: 'Task 1' }];
    const fetchMock = vi.fn().mockResolvedValue({
      ok: true,
      status: 200,
      statusText: 'OK',
      json: async () => ({ data: { tasks } }),
    });
    vi.stubGlobal('fetch', fetchMock);

    const result = await fetchTasks();

    expect(result).toEqual(tasks);
    expect(fetchMock).toHaveBeenCalledTimes(1);
    expect(fetchMock).toHaveBeenCalledWith(
      'https://api.tarkov.dev/graphql',
      expect.objectContaining({
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
      })
    );
  });

  it('fetchTasks throws when HTTP response is not ok', async () => {
    vi.stubGlobal(
      'fetch',
      vi.fn().mockResolvedValue({
        ok: false,
        status: 503,
        statusText: 'Service Unavailable',
        json: async () => ({}),
      })
    );

    await expect(fetchTasks()).rejects.toThrow(
      'API request failed: 503 Service Unavailable'
    );
  });

  it('fetchTasks throws when GraphQL errors are returned', async () => {
    vi.stubGlobal(
      'fetch',
      vi.fn().mockResolvedValue({
        ok: true,
        status: 200,
        statusText: 'OK',
        json: async () => ({
          errors: [{ message: 'Something failed' }],
        }),
      })
    );

    await expect(fetchTasks()).rejects.toThrow('GraphQL errors');
  });

  it('fetchTasks sends pve gameMode variables when requested', async () => {
    const fetchMock = vi.fn().mockResolvedValue({
      ok: true,
      status: 200,
      statusText: 'OK',
      json: async () => ({ data: { tasks: [] } }),
    });
    vi.stubGlobal('fetch', fetchMock);

    await fetchTasks('pve');

    const request = fetchMock.mock.calls[0][1] as { body?: string };
    const payload = JSON.parse(String(request.body)) as {
      variables?: { gameMode?: string };
    };

    expect(payload.variables).toEqual({ gameMode: 'pve' });
  });

  it('fetchTasks throws when GraphQL response is not an object', async () => {
    vi.stubGlobal(
      'fetch',
      vi.fn().mockResolvedValue({
        ok: true,
        status: 200,
        statusText: 'OK',
        json: async () => null,
      })
    );

    await expect(fetchTasks()).rejects.toThrow(
      'Invalid GraphQL response: expected an object, got null'
    );
  });

  it('fetchTasks throws when GraphQL response is missing data', async () => {
    vi.stubGlobal(
      'fetch',
      vi.fn().mockResolvedValue({
        ok: true,
        status: 200,
        statusText: 'OK',
        json: async () => ({}),
      })
    );

    await expect(fetchTasks()).rejects.toThrow(
      'Invalid GraphQL response: missing data field'
    );
  });

  it('fetchTasks throws when GraphQL response is missing tasks', async () => {
    vi.stubGlobal(
      'fetch',
      vi.fn().mockResolvedValue({
        ok: true,
        status: 200,
        statusText: 'OK',
        json: async () => ({ data: {} }),
      })
    );

    await expect(fetchTasks()).rejects.toThrow(
      'Invalid GraphQL response: missing data.tasks'
    );
  });

  it('fetchTasks throws when GraphQL tasks payload is not an array', async () => {
    vi.stubGlobal(
      'fetch',
      vi.fn().mockResolvedValue({
        ok: true,
        status: 200,
        statusText: 'OK',
        json: async () => ({ data: { tasks: {} } }),
      })
    );

    await expect(fetchTasks()).rejects.toThrow(
      'Invalid GraphQL response: expected data.tasks to be an array, got object'
    );
  });

  it('findTaskById returns matching task', () => {
    const tasks: TaskData[] = [
      { id: 'task-1', name: 'Task 1' },
      { id: 'task-2', name: 'Task 2' },
    ];

    expect(findTaskById(tasks, 'task-2')).toEqual({ id: 'task-2', name: 'Task 2' });
    expect(findTaskById(tasks, 'missing')).toBeUndefined();
  });
});
